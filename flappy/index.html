<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI Game Portal - Flappy Bird</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #70c5ce;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: 'Arial', sans-serif;
        }

        /* 점수판 디자인 */
        .score-wrapper {
            position: absolute;
            top: 80px;
            display: flex;
            gap: 20px;
            z-index: 10;
        }

        .score-box {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            text-align: center;
            color: white;
        }

        canvas {
            background-color: #70c5ce;
            border: 4px solid #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            display: block;
        }
    </style>
</head>
<body>

    <script src="../navbar.js"></script>

    <div class="score-wrapper">
        <div class="score-box">SCORE: <span id="score-val">0</span></div>
        <div class="score-box">BEST: <span id="best-val">0</span></div>
    </div>
    
    <canvas id="flappyCanvas" width="400" height="600"></canvas>

    <script>
        const canvas = document.getElementById("flappyCanvas");
        const ctx = canvas.getContext("2d");
        const scoreElement = document.getElementById("score-val");
        const bestElement = document.getElementById("best-val");

        // 게임 설정
        let birdX = 50;
        let birdY = 300;
        let birdSize = 20;
        let gravity = 0.25;
        let velocity = 0;
        let lift = -6;
        let score = 0;
        let bestScore = localStorage.getItem('flappy-best-score') || 0;
        bestElement.innerText = bestScore;

        let pipes = [];
        let pipeWidth = 50;
        let pipeGap = 150;
        let frameCount = 0;
        let gameLoop;
        
        // [추가] 게임 상태 관리 변수
        let isGameStarted = false;

        // 입력 이벤트 통합 관리
        function handleInput(e) {
            if (e.type === "keydown" && e.code !== "Space") return;

            // 게임이 시작되지 않은 상태라면 시작시킴
            if (!isGameStarted) {
                isGameStarted = true;
                gameLoop = requestAnimationFrame(draw);
            }
            
            // 새 점프
            velocity = lift; 
        }

        window.addEventListener("keydown", handleInput);
        canvas.addEventListener("mousedown", handleInput);

        function initGame() {
            // 변수 초기화
            birdY = 300;
            velocity = 0;
            score = 0;
            pipes = [];
            frameCount = 0;
            scoreElement.innerText = score;
            isGameStarted = false; // 시작 전 상태로 설정

            if (gameLoop) cancelAnimationFrame(gameLoop);
            
            // 첫 화면 그리기 (새와 배경만 보여줌)
            renderInitialState();
        }

        // 게임 시작 전 대기 화면을 그리는 함수
        function renderInitialState() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 새 그리기
            ctx.fillStyle = "#f1c40f";
            ctx.fillRect(birdX, birdY, birdSize, birdSize);
            
            // 안내 문구 추가
            ctx.fillStyle = "white";
            ctx.font = "20px Arial";
            ctx.textAlign = "center";
            ctx.fillText("Press Space or Click to Start", canvas.width / 2, canvas.height / 2 + 50);
        }

        function draw() {
            if (!isGameStarted) return; // 게임 중지가 되면 그리지 않음

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 1. 새 물리 연산
            velocity += gravity;
            birdY += velocity;

            // 2. 파이프 생성
            if (frameCount % 100 === 0) {
                let pipeHeight = Math.random() * (canvas.height / 2);
                pipes.push({ x: canvas.width, top: pipeHeight });
            }

            // 3. 파이프 이동 및 그리기
            ctx.fillStyle = "#2ecc71";
            for (let i = pipes.length - 1; i >= 0; i--) {
                pipes[i].x -= 3;
                ctx.fillRect(pipes[i].x, 0, pipeWidth, pipes[i].top);
                ctx.fillRect(pipes[i].x, pipes[i].top + pipeGap, pipeWidth, canvas.height);

                if (pipes[i].x + pipeWidth === birdX) {
                    score++;
                    scoreElement.innerText = score;
                }

                if (birdX + birdSize > pipes[i].x && birdX < pipes[i].x + pipeWidth) {
                    if (birdY < pipes[i].top || birdY + birdSize > pipes[i].top + pipeGap) {
                        gameOver();
                        return;
                    }
                }
                if (pipes[i].x < -pipeWidth) pipes.splice(i, 1);
            }

            // 4. 새 그리기
            ctx.fillStyle = "#f1c40f";
            ctx.fillRect(birdX, birdY, birdSize, birdSize);

            // 5. 바닥/천장 충돌
            if (birdY + birdSize > canvas.height || birdY < 0) {
                gameOver();
                return;
            }

            frameCount++;
            gameLoop = requestAnimationFrame(draw);
        }

        function gameOver() {
            isGameStarted = false;
            if (score > bestScore) {
                bestScore = score;
                localStorage.setItem('flappy-best-score', bestScore);
                bestElement.innerText = bestScore;
                alert("최고 기록 달성! 점수: " + score);
            } else {
                alert("게임 종료! 점수: " + score);
            }
            initGame();
        }

        initGame();
    </script>
</body>
</html>
